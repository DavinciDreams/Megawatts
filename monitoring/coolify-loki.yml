# Loki Configuration for Coolify Deployment
# Optimized for Discord Bot log aggregation

auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096
  http_server_read_timeout: 60s
  http_server_write_timeout: 60s
  grpc_server_max_recv_msg_size: 4194304
  grpc_server_max_send_msg_size: 4194304
  grpc_server_max_concurrent_streams: 1000

ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
    final_sleep: 0s
  chunk_idle_period: 1h
  max_chunk_age: 1h
  chunk_target_size: 1048576
  chunk_retain_period: 30s
  max_transfer_retries: 0
  wal:
    enabled: true
    dir: /loki/wal
    checkpoint_duration: 5m
    flush_on_shutdown: true

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h
      chunks:
        prefix: chunk_
        period: 24h

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    cache_location: /loki/boltdb-shipper-cache
    shared_store: filesystem
  filesystem:
    directory: /loki/chunks

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h
  max_cache_freshness_per_query: 10m
  split_queries_by_interval: 15m
  ingestion_rate_mb: 16
  ingestion_burst_size_mb: 32
  per_stream_rate_limit: 16MB
  per_stream_rate_limit_burst: 32MB

chunk_store_config:
  max_look_back_period: 0s
  RING:
    kvstore:
      store: inmemory

table_manager:
  retention_deletes_enabled: true
  retention_period: 168h

query_range:
  parallelise_shardable_queries: true
  cache_results: true
  results_cache:
    cache:
      enable_fifocache: true
      fifocache:
        max_size_items: 1024
        ttl: 24h

frontend:
  max_outstanding_per_tenant: 2048
  compress_responses: true
  log_queries_longer_than: 0s
  tail_proxy_url: ""

frontend_worker:
  scheduler_address: 127.0.0.1:9095
  frontend_address: 127.0.0.1:3100
  grpc_client_config: {}

ruler:
  enable: true
  enable_api: true
  storage:
    type: local
    local:
      directory: /loki/rules
  rule_path: /loki/rules-temp
  alertmanager_url: http://alertmanager:9093
  ring:
    kvstore:
      store: inmemory
  remote_write:
    enabled: false
  remote_read:
    enabled: false

# Custom log parsing rules for Discord Bot
chunk_store_config:
  max_look_back_period: 0s
  RING:
    kvstore:
      store: inmemory

# Log processing rules
ingester_client:
  grpc_client_config:
    max_send_msg_size: 1048576
    grpc_compression: gzip

# Query configuration
query_scheduler:
  max_concurrent_queries: 10
  grpc_client_config: {}

# Multi-tenant configuration
auth_enabled: false
tenant_config: {}

# Index gateway configuration
index_gateway:
  mode: simple
  ring:
    kvstore:
      store: inmemory

# Compactor configuration
compactor:
  working_directory: /loki/compactor
  shared_store: filesystem
  compaction_interval: 10m
  retention_enabled: true
  retention_delete_delay: 2h
  retention_delete_worker_count: 150

# Log collection from Docker containers
# This configuration works with Promtail to collect logs from Discord Bot containers
# Promtail configuration should be set up separately to forward logs to Loki

# Custom log parsing for Discord Bot events
# These rules will be used by Promtail to parse and structure logs
# Example log patterns:
# - Discord API events
# - Bot command executions
# - Error logs
# - Performance metrics
# - User activity logs

# Log retention policies
# Production: 7 days for all logs
# Error logs: 30 days
# Performance logs: 14 days
# Debug logs: 3 days

# Query optimization
# - Use label filters for efficient querying
# - Limit time ranges for better performance
# - Use regex patterns for specific log parsing
# - Implement log sampling for high-volume logs

# Example Promtail configuration (to be used separately):
# scrape_configs:
#   - job_name: discord-bot
#     docker_sd_configs:
#       - host: unix:///var/run/docker.sock
#         refresh_interval: 5s
#     relabel_configs:
#       - source_labels: [__meta_docker_container_label_com_docker_compose_service]
#         action: keep
#         regex: discord-bot
#       - source_labels: [__meta_docker_container_name]
#         target_label: container
#       - source_labels: [__meta_docker_container_log_stream]
#         target_label: stream
#       - source_labels: [__meta_docker_container_label_com_docker_compose_project]
#         target_label: project
#     pipeline_stages:
#       - json:
#           expressions:
#             level: level
#             message: message
#             timestamp: timestamp
#             service: service
#             component: component
#             user_id: user_id
#             guild_id: guild_id
#             command: command
#             error: error
#       - labels:
#           level:
#           service:
#           component:
#       - timestamp:
#           format: RFC3339Nano
#           source: timestamp
#       - regex:
#           expression: '(?P<command>\w+)\s+executed by user\s+(?P<user_id>\d+)'
#           source: message
#       - regex:
#           expression: 'Error in\s+(?P<component>\w+):\s+(?P<error>.+)'
#           source: message

# Log volume estimation for Discord Bot:
# - Production: ~10MB/hour (3 replicas)
# - Staging: ~5MB/hour (2 replicas)
# - Peak hours: 2-3x normal volume
# - Error conditions: 5-10x normal volume

# Performance tuning:
# - Adjust chunk_target_size based on log volume
# - Tune ingestion_rate_mb for high-volume periods
# - Configure cache_size for better query performance
# - Set appropriate retention periods based on storage capacity