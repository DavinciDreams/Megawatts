# =============================================================================
# Discord Bot Coolify Environment Configuration
# =============================================================================
# This file defines environment-specific configurations for the Discord bot deployment
# using Coolify. It includes separate configurations for development, staging, and production.
# =============================================================================

version: "3.8"

# =============================================================================
# Base Configuration
# =============================================================================
x-common-variables: &common-variables
  NODE_ENV: ${NODE_ENV:-staging}
  LOG_LEVEL: ${LOG_LEVEL:-info}
  DOMAIN: ${DOMAIN:-your-domain.com}

x-common-secrets: &common-secrets
  DISCORD_TOKEN: ${DISCORD_TOKEN}
  DB_USER: ${DB_USER}
  DB_PASSWORD: ${DB_PASSWORD}
  DB_NAME: ${DB_NAME}
  REDIS_PASSWORD: ${REDIS_PASSWORD}
  REDIS_DB: ${REDIS_DB}
  OPENAI_API_KEY: ${OPENAI_API_KEY}
  ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
  S3_BUCKET: ${S3_BUCKET}
  S3_REGION: ${S3_REGION}
  S3_ACCESS_KEY_ID: ${S3_ACCESS_KEY_ID}
  S3_SECRET_ACCESS_KEY: ${S3_SECRET_ACCESS_KEY}

x-database-variables: &database-variables
  POSTGRES_INITDB_ARGS: "--encoding=UTF8 --data-checksum"
  POSTGRES_REPLICAS: ${POSTGRES_REPLICAS:-1}
  POSTGRES_CPU_LIMIT: ${POSTGRES_CPU_LIMIT:-0.5}
  POSTGRES_MEMORY_LIMIT: ${POSTGRES_MEMORY_LIMIT:-256M}
  POSTGRES_DATA_PATH: ${POSTGRES_DATA_PATH:-./data/postgres}

x-redis-variables: &redis-variables
  REDIS_CPU_LIMIT: ${REDIS_CPU_LIMIT:-0.25}
  REDIS_MEMORY_LIMIT: ${REDIS_MEMORY_LIMIT:-128M}
  REDIS_DATA_PATH: ${REDIS_DATA_PATH:-./data/redis}

x-app-variables: &app-variables
  APP_PORT: ${APP_PORT:-8080}
  APP_REPLICAS: ${APP_REPLICAS:-2}
  APP_CPU_LIMIT: ${APP_CPU_LIMIT:-0.75}
  APP_MEMORY_LIMIT: ${APP_MEMORY_LIMIT:-384M}

x-monitoring-variables: &monitoring-variables
  PROMETHEUS_PORT: ${PROMETHEUS_PORT:-9090}
  PROMETHEUS_RETENTION: ${PROMETHEUS_RETENTION:-72h}
  PROMETHEUS_CPU_LIMIT: ${PROMETHEUS_CPU_LIMIT:-0.25}
  PROMETHEUS_MEMORY_LIMIT: ${PROMETHEUS_MEMORY_LIMIT:-256M}
  PROMETHEUS_DATA_PATH: ${PROMETHEUS_DATA_PATH:-./data/prometheus}
  GRAFANA_PORT: ${GRAFANA_PORT:-3000}
  GRAFANA_PASSWORD: ${GRAFANA_PASSWORD}
  GRAFANA_DOMAIN: ${GRAFANA_DOMAIN:-grafana.your-domain.com}
  GRAFANA_PLUGINS: ${GRAFANA_PLUGINS:-}
  GRAFANA_CPU_LIMIT: ${GRAFANA_CPU_LIMIT:-0.25}
  GRAFANA_MEMORY_LIMIT: ${GRAFANA_MEMORY_LIMIT:-256M}
  GRAFANA_DATA_PATH: ${GRAFANA_DATA_PATH:-./data/grafana}

x-nginx-variables: &nginx-variables
  NGINX_HTTP_PORT: ${NGINX_HTTP_PORT:-80}
  NGINX_HTTPS_PORT: ${NGINX_HTTPS_PORT:-443}
  NGINX_CPU_LIMIT: ${NGINX_CPU_LIMIT:-0.25}
  NGINX_MEMORY_LIMIT: ${NGINX_MEMORY_LIMIT:-128M}

x-traefik-variables: &traefik-variables
  TRAEFIK_HTTP_PORT: ${TRAEFIK_HTTP_PORT:-8081}
  TRAEFIK_HTTPS_PORT: ${TRAEFIK_HTTPS_PORT:-8443}
  TRAEFIK_DASHBOARD_PORT: ${TRAEFIK_DASHBOARD_PORT:-8082}
  TRAEFIK_CPU_LIMIT: ${TRAEFIK_CPU_LIMIT:-0.25}
  TRAEFIK_MEMORY_LIMIT: ${TRAEFIK_MEMORY_LIMIT:-128M}

x-network-variables: &network-variables
  NETWORK_SUBNET: ${NETWORK_SUBNET:-172.22.0.0/16}

# =============================================================================
# Development Environment
# =============================================================================
environments:
  development:
    name: "Development"
    description: "Development environment for local testing and development"
    default: false
    
    variables:
      <<: *common-variables
      NODE_ENV: "development"
      LOG_LEVEL: "debug"
      <<: *app-variables
      <<: *database-variables
      <<: *redis-variables
      <<: *monitoring-variables
      <<: *nginx-variables
      <<: *traefik-variables
      <<: *network-variables
      
      # Development-specific overrides
      APP_REPLICAS: 1
      APP_CPU_LIMIT: 0.5
      APP_MEMORY_LIMIT: 256M
      POSTGRES_REPLICAS: 1
      PROMETHEUS_RETENTION: 24h
      
      # Development ports to avoid conflicts
      POSTGRES_PORT: 5434
      REDIS_PORT: 6381
      PROMETHEUS_PORT: 9092
      GRAFANA_PORT: 3002
      NGINX_HTTP_PORT: 8080
      NGINX_HTTPS_PORT: 8443
      
    secrets:
      <<: *common-secrets
      GRAFANA_PASSWORD: ${GRAFANA_PASSWORD}
      
    resource_overrides:
      discord-bot:
        replicas: 1
        cpu_limit: "500m"
        memory_limit: "256Mi"
        deployment_strategy:
          type: "recreate"
          max_unavailable: "100%"
          max_surge: "0%"
          progress_deadline_seconds: 300
        health_check:
          path: "/health"
          port: 8080
          interval_seconds: 60
          timeout_seconds: 15
          failure_threshold: 5
          success_threshold: 1
          
      postgres:
        replicas: 1
        cpu_limit: "500m"
        memory_limit: "256Mi"
        persistent_volume_size: "2Gi"
        
      redis:
        cpu_limit: "250m"
        memory_limit: "128Mi"
        persistent_volume_size: "512Mi"
        
      prometheus:
        cpu_limit: "250m"
        memory_limit: "256Mi"
        persistent_volume_size: "1Gi"
        
      grafana:
        cpu_limit: "250m"
        memory_limit: "256Mi"
        persistent_volume_size: "512Mi"
        
      nginx:
        cpu_limit: "250m"
        memory_limit: "128Mi"

# =============================================================================
# Staging Environment
# =============================================================================
  staging:
    name: "Staging"
    description: "Staging environment for testing and validation"
    default: true
    
    variables:
      <<: *common-variables
      NODE_ENV: "staging"
      LOG_LEVEL: "debug"
      <<: *app-variables
      <<: *database-variables
      <<: *redis-variables
      <<: *monitoring-variables
      <<: *nginx-variables
      <<: *traefik-variables
      <<: *network-variables
      
      # Staging-specific overrides
      APP_REPLICAS: 2
      APP_CPU_LIMIT: 0.75
      APP_MEMORY_LIMIT: 384M
      POSTGRES_REPLICAS: 1
      PROMETHEUS_RETENTION: 72h
      
      # Staging ports to avoid conflicts
      POSTGRES_PORT: 5433
      REDIS_PORT: 6380
      PROMETHEUS_PORT: 9091
      GRAFANA_PORT: 3001
      
    secrets:
      <<: *common-secrets
      GRAFANA_PASSWORD: ${GRAFANA_PASSWORD_STAGING}
      
    resource_overrides:
      discord-bot:
        replicas: 2
        cpu_limit: "750m"
        memory_limit: "384Mi"
        deployment_strategy:
          type: "rolling"
          max_unavailable: "50%"
          max_surge: "50%"
          progress_deadline_seconds: 300
        health_check:
          path: "/health"
          port: 8080
          interval_seconds: 30
          timeout_seconds: 10
          failure_threshold: 3
          success_threshold: 1
          
      postgres:
        replicas: 1
        cpu_limit: "500m"
        memory_limit: "256Mi"
        persistent_volume_size: "5Gi"
        
      redis:
        cpu_limit: "250m"
        memory_limit: "128Mi"
        persistent_volume_size: "1Gi"
        
      prometheus:
        cpu_limit: "250m"
        memory_limit: "256Mi"
        persistent_volume_size: "5Gi"
        
      grafana:
        cpu_limit: "250m"
        memory_limit: "256Mi"
        persistent_volume_size: "2Gi"
        
      nginx:
        cpu_limit: "250m"
        memory_limit: "128Mi"

# =============================================================================
# Production Environment
# =============================================================================
  production:
    name: "Production"
    description: "Production environment with full monitoring and scaling"
    default: false
    
    variables:
      <<: *common-variables
      NODE_ENV: "production"
      LOG_LEVEL: "info"
      <<: *app-variables
      <<: *database-variables
      <<: *redis-variables
      <<: *monitoring-variables
      <<: *nginx-variables
      <<: *traefik-variables
      <<: *network-variables
      
      # Production-specific overrides
      APP_REPLICAS: 3
      APP_CPU_LIMIT: 1.0
      APP_MEMORY_LIMIT: 512M
      POSTGRES_REPLICAS: 2
      PROMETHEUS_RETENTION: 200h
      
      # Production standard ports
      POSTGRES_PORT: 5432
      REDIS_PORT: 6379
      PROMETHEUS_PORT: 9090
      GRAFANA_PORT: 3000
      NGINX_HTTP_PORT: 80
      NGINX_HTTPS_PORT: 443
      
    secrets:
      <<: *common-secrets
      GRAFANA_PASSWORD: ${GRAFANA_PASSWORD}
      
    resource_overrides:
      discord-bot:
        replicas: 3
        cpu_limit: "1000m"
        memory_limit: "512Mi"
        deployment_strategy:
          type: "rolling"
          max_unavailable: "25%"
          max_surge: "25%"
          progress_deadline_seconds: 600
        health_check:
          path: "/health"
          port: 8080
          interval_seconds: 30
          timeout_seconds: 10
          failure_threshold: 3
          success_threshold: 1
          
      postgres:
        replicas: 2
        cpu_limit: "500m"
        memory_limit: "256Mi"
        persistent_volume_size: "10Gi"
        
      redis:
        cpu_limit: "250m"
        memory_limit: "128Mi"
        persistent_volume_size: "2Gi"
        
      prometheus:
        cpu_limit: "500m"
        memory_limit: "512Mi"
        persistent_volume_size: "20Gi"
        
      grafana:
        cpu_limit: "250m"
        memory_limit: "256Mi"
        persistent_volume_size: "5Gi"
        
      nginx:
        cpu_limit: "250m"
        memory_limit: "128Mi"

# =============================================================================
# Environment-Specific Secret Mappings
# =============================================================================
secret_mappings:
  development:
    DISCORD_TOKEN: "DISCORD_TOKEN_DEV"
    DB_USER: "DB_USER_DEV"
    DB_PASSWORD: "DB_PASSWORD_DEV"
    DB_NAME: "DB_NAME_DEV"
    REDIS_PASSWORD: "REDIS_PASSWORD_DEV"
    OPENAI_API_KEY: "OPENAI_API_KEY_DEV"
    ANTHROPIC_API_KEY: "ANTHROPIC_API_KEY_DEV"
    S3_BUCKET: "S3_BUCKET_DEV"
    S3_ACCESS_KEY_ID: "S3_ACCESS_KEY_ID_DEV"
    S3_SECRET_ACCESS_KEY: "S3_SECRET_ACCESS_KEY_DEV"
    GRAFANA_PASSWORD: "GRAFANA_PASSWORD_DEV"
    
  staging:
    DISCORD_TOKEN: "DISCORD_TOKEN_STAGING"
    DB_USER: "DB_USER_STAGING"
    DB_PASSWORD: "DB_PASSWORD_STAGING"
    DB_NAME: "DB_NAME_STAGING"
    REDIS_PASSWORD: "REDIS_PASSWORD_STAGING"
    OPENAI_API_KEY: "OPENAI_API_KEY_STAGING"
    ANTHROPIC_API_KEY: "ANTHROPIC_API_KEY_STAGING"
    S3_BUCKET: "S3_BUCKET_STAGING"
    S3_ACCESS_KEY_ID: "S3_ACCESS_KEY_ID_STAGING"
    S3_SECRET_ACCESS_KEY: "S3_SECRET_ACCESS_KEY_STAGING"
    GRAFANA_PASSWORD: "GRAFANA_PASSWORD_STAGING"
    
  production:
    DISCORD_TOKEN: "DISCORD_TOKEN"
    DB_USER: "DB_USER"
    DB_PASSWORD: "DB_PASSWORD"
    DB_NAME: "DB_NAME"
    REDIS_PASSWORD: "REDIS_PASSWORD"
    OPENAI_API_KEY: "OPENAI_API_KEY"
    ANTHROPIC_API_KEY: "ANTHROPIC_API_KEY"
    S3_BUCKET: "S3_BUCKET"
    S3_ACCESS_KEY_ID: "S3_ACCESS_KEY_ID"
    S3_SECRET_ACCESS_KEY: "S3_SECRET_ACCESS_KEY"
    GRAFANA_PASSWORD: "GRAFANA_PASSWORD"

# =============================================================================
# Validation Rules
# =============================================================================
validation_rules:
  required_secrets:
    - DISCORD_TOKEN
    - DB_USER
    - DB_PASSWORD
    - DB_NAME
    - REDIS_PASSWORD
    - OPENAI_API_KEY
    - S3_BUCKET
    - S3_REGION
    - S3_ACCESS_KEY_ID
    - S3_SECRET_ACCESS_KEY
    - GRAFANA_PASSWORD
    
  optional_secrets:
    - ANTHROPIC_API_KEY
    
  secret_format_validation:
    DISCORD_TOKEN:
      pattern: "^[A-Za-z0-9_-]{50,}$"
      description: "Discord bot token (alphanumeric, underscore, hyphen, min 50 chars)"
    DB_PASSWORD:
      pattern: "^.{8,}$"
      description: "Database password (min 8 chars)"
    REDIS_PASSWORD:
      pattern: "^.{8,}$"
      description: "Redis password (min 8 chars)"
    OPENAI_API_KEY:
      pattern: "^sk-[A-Za-z0-9]{48}$"
      description: "OpenAI API key (sk- followed by 48 alphanumeric chars)"
    ANTHROPIC_API_KEY:
      pattern: "^sk-ant-api[0-9]{3}-[A-Za-z0-9_-]{95}$"
      description: "Anthropic API key (sk-ant-api followed by pattern)"
    S3_ACCESS_KEY_ID:
      pattern: "^[A-Za-z0-9]{16,20}$"
      description: "S3 Access Key ID (16-20 alphanumeric chars)"
    S3_SECRET_ACCESS_KEY:
      pattern: "^[A-Za-z0-9+/]{40}$"
      description: "S3 Secret Access Key (40 alphanumeric chars with possible +/)"
    GRAFANA_PASSWORD:
      pattern: "^.{8,}$"
      description: "Grafana admin password (min 8 chars)"