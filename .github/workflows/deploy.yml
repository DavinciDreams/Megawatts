name: Deploy to Environments

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types:
      - completed
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      strategy:
        description: 'Deployment strategy'
        required: true
        default: 'blue-green'
        type: choice
        options:
          - blue-green
          - rolling
          - canary
      version:
        description: 'Specific version to deploy (optional)'
        required: false
        type: string
      force:
        description: 'Force deployment'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Deploy to Staging
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.discord-bot.example.com
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging' ||
      github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/develop'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_STAGING }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_STAGING }}
          aws-region: us-east-1

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Deploy to staging
        run: |
          npm run deploy -- \
            --env staging \
            --strategy ${{ github.event.inputs.strategy || 'blue-green' }} \
            ${{ github.event.inputs.version && format('--version {0}', github.event.inputs.version) || '' }} \
            ${{ github.event.inputs.force == 'true' && '--force' || '' }}
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN_STAGING }}
          DB_HOST: ${{ secrets.DB_HOST_STAGING }}
          DB_USER: ${{ secrets.DB_USER_STAGING }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD_STAGING }}
          DB_NAME: ${{ secrets.DB_NAME_STAGING }}
          REDIS_HOST: ${{ secrets.REDIS_HOST_STAGING }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD_STAGING }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY_STAGING }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY_STAGING }}
          S3_BUCKET: ${{ secrets.S3_BUCKET_STAGING }}
          S3_REGION: ${{ secrets.S3_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_STAGING }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_STAGING }}

      - name: Run smoke tests
        run: |
          npm run test:smoke -- --env staging
        env:
          STAGING_URL: https://staging.discord-bot.example.com

      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow

  # Deploy to Production
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://discord-bot.example.com
    if: |
      github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production' ||
      github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.ref == 'refs/heads/main'
    needs: [deploy-staging]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: us-east-1

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Create deployment approval
        uses: trstringer/manual-approval@v1
        with:
          secret: ${{ github.TOKEN }}
          approvers: team-leads
          minimum-approvals: 2
          issue-title: "Production Deployment Approval"
          issue-body: |
            ## Production Deployment Request
            
            **Version**: ${{ github.event.inputs.version || github.sha }}
            **Strategy**: ${{ github.event.inputs.strategy || 'blue-green' }}
            **Requested by**: ${{ github.actor }}
            **Branch**: ${{ github.ref }}
            
            Please review the changes and approve if ready for production deployment.

      - name: Deploy to production
        run: |
          npm run deploy -- \
            --env production \
            --strategy ${{ github.event.inputs.strategy || 'blue-green' }} \
            ${{ github.event.inputs.version && format('--version {0}', github.event.inputs.version) || '' }} \
            ${{ github.event.inputs.force == 'true' && '--force' || '' }}
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN_PROD }}
          DB_HOST: ${{ secrets.DB_HOST_PROD }}
          DB_USER: ${{ secrets.DB_USER_PROD }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD_PROD }}
          DB_NAME: ${{ secrets.DB_NAME_PROD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST_PROD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD_PROD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY_PROD }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY_PROD }}
          S3_BUCKET: ${{ secrets.S3_BUCKET_PROD }}
          S3_REGION: ${{ secrets.S3_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}

      - name: Run smoke tests
        run: |
          npm run test:smoke -- --env production
        env:
          PRODUCTION_URL: https://discord-bot.example.com

      - name: Run performance validation
        run: |
          npm run test:performance -- --env production --threshold

      - name: Notify Slack
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow

  # Rollback Job
  rollback:
    name: Rollback Deployment
    runs-on: ubuntu-latest
    if: failure() && needs.deploy-production.result == 'failure'
    needs: deploy-production
    environment:
      name: production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          aws-region: us-east-1

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Configure kubectl
        run: |
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > kubeconfig
          export KUBECONFIG=kubeconfig

      - name: Get previous stable version
        id: get-version
        run: |
          VERSION=$(kubectl get deployment discord-bot-prod -o jsonpath='{.spec.template.spec.containers[0].image}' | cut -d: -f2 | cut -d- -f1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Rollback to previous version
        run: |
          npm run deploy -- \
            --env production \
            --strategy blue-green \
            --version ${{ steps.get-version.outputs.version }} \
            --force
        env:
          DISCORD_TOKEN: ${{ secrets.DISCORD_TOKEN_PROD }}
          DB_HOST: ${{ secrets.DB_HOST_PROD }}
          DB_USER: ${{ secrets.DB_USER_PROD }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD_PROD }}
          DB_NAME: ${{ secrets.DB_NAME_PROD }}
          REDIS_HOST: ${{ secrets.REDIS_HOST_PROD }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD_PROD }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY_PROD }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY_PROD }}
          S3_BUCKET: ${{ secrets.S3_BUCKET_PROD }}
          S3_REGION: ${{ secrets.S3_REGION }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}

      - name: Notify rollback
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#alerts'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: |
            ðŸš¨ PRODUCTION ROLLBACK TRIGGERED ðŸš¨
            
            Deployment to production failed and has been rolled back to previous stable version.
            
            Please investigate the cause and fix any issues before redeploying.

  # Post-deployment monitoring
  monitor:
    name: Post-deployment Monitoring
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')
    steps:
      - name: Wait for deployment stabilization
        run: sleep 300

      - name: Check deployment health
        run: |
          # Check health endpoints
          curl -f https://staging.discord-bot.example.com/health || echo "Staging health check failed"
          curl -f https://discord-bot.example.com/health || echo "Production health check failed"

      - name: Monitor error rates
        run: |
          # Query monitoring systems for error rates
          # This would integrate with your monitoring solution
          echo "Checking error rates..."

      - name: Validate performance metrics
        run: |
          # Validate key performance metrics
          # This would integrate with your monitoring solution
          echo "Validating performance metrics..."

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ needs.deploy-production.result == 'success' && 'Production' || 'Staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy**: ${{ github.event.inputs.strategy || 'blue-green' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.deploy-production.result == 'success' && 'Success' || needs.deploy-staging.result == 'success' && 'Success' || 'Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date)" >> $GITHUB_STEP_SUMMARY