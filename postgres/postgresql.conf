# PostgreSQL Configuration File for Production Environment
# Optimized for Discord Bot workloads

# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

# Connection settings
listen_addresses = '*'                  # Listen on all interfaces
port = 5432                             # Default port
max_connections = 200                   # Maximum number of connections

# Authentication settings
authentication_timeout = 1min           # Maximum time to complete client authentication
password_encryption = scram-sha-256     # Use stronger password encryption

# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------

# Memory
shared_buffers = 256MB                 # Use 25% of available RAM
huge_pages = try                        # Try to use huge pages
temp_buffers = 32MB                     # Temporary buffers
max_prepared_transactions = 0          # Disabled for simplicity
work_mem = 4MB                          # Memory for internal sort operations and hash tables
hash_mem_multiplier = 1.0               # Multiplier for hash table memory operations
maintenance_work_mem = 64MB             # Memory for maintenance operations
autovacuum_work_mem = -1                # Use maintenance_work_mem
max_stack_depth = 2MB                  # Maximum stack depth
shared_memory_type = mmap               # Use mmap for shared memory
dynamic_shared_memory_type = posix      # Use POSIX for dynamic shared memory

# Free Space Map
max_fsm_pages = 204800                  # FSM pages (deprecated in newer versions)
max_fsm_relations = 1000                # FSM relations (deprecated in newer versions)

# Vacuum settings
vacuum_cost_delay = 0                  # No delay for vacuum operations
vacuum_cost_page_hit = 1               # Cost for a page found in the buffer cache
vacuum_cost_page_miss = 10             # Cost for a page not found in the buffer cache
vacuum_cost_page_dirty = 20            # Cost for dirtied pages during vacuum
vacuum_cost_limit = 200                # Limit for vacuum cost accumulation

# Background Writer
bgwriter_delay = 200ms                  # Background writer delay
bgwriter_lru_maxpages = 100             # Maximum pages to flush per round
bgwriter_lru_multiplier = 2.0           # Multiplier for number of pages to flush
bgwriter_flush_after = 0                # Disabled

# Asynchronous Behavior
effective_io_concurrency = 200          # Number of simultaneous disk I/O operations
maintenance_io_concurrency = 10         # Number of simultaneous disk I/O operations for maintenance
max_worker_processes = 8               # Maximum number of background processes
max_parallel_workers_per_gather = 2     # Maximum parallel workers per gather
max_parallel_maintenance_workers = 2     # Maximum parallel workers for maintenance
max_parallel_workers = 8                # Maximum parallel workers

# WRITE-AHEAD LOG
#------------------------------------------------------------------------------

# Settings
wal_level = replica                     # Write enough WAL to enable replication
fsync = on                              # Force fsync to disk
synchronous_commit = on                 # Synchronous commit level
wal_sync_method = fsync                 # Method for forcing WAL updates to disk
full_page_writes = on                   # Write full pages to WAL
wal_compression = on                    # Compress full-page writes
wal_log_hints = off                     # Log WAL hints
wal_init_zero = on                      # Zero-fill new WAL files
wal_recycle = on                        # Recycle WAL files
wal_buffers = 16MB                      # WAL buffer size
wal_writer_delay = 200ms                # WAL writer delay
wal_writer_flush_after = 1MB            # Flush WAL after this amount

# Checkpoints
checkpoint_timeout = 15min              # Maximum time between automatic WAL checkpoints
checkpoint_completion_target = 0.9      # Target for checkpoint completion
checkpoint_flush_after = 256kB          # Flush after this amount during checkpoint
checkpoint_warning = 30s                # Warning if checkpoint takes longer than this
max_wal_size = 1GB                      # Maximum WAL size between checkpoints
min_wal_size = 80MB                     # Minimum WAL size between checkpoints

# Archiving
archive_mode = off                      # Disabled for production (can be enabled for backup)
archive_command = ''                    # Command to archive WAL files
archive_timeout = 0                     # Timeout for archiving

# REPLICATION
#------------------------------------------------------------------------------

# Sending Servers
max_wal_senders = 3                     # Maximum number of concurrent WAL sender processes
max_replication_slots = 3               # Maximum number of replication slots
wal_keep_size = 0                       # Minimum WAL size to keep for replication
wal_sender_timeout = 60s                # Timeout for WAL sender
track_commit_timestamp = off            # Track commit timestamp

# Standby Servers
hot_standby = on                        # Allow queries during recovery
max_standby_archive_delay = 30s         # Maximum delay for standby servers
max_standby_streaming_delay = 30s       # Maximum delay for streaming replication
wal_receiver_create_temp_slot = off    # Create temporary replication slot
wal_receiver_status_interval = 10s     # Status report interval
hot_standby_feedback = off             # Feedback from standby to primary
wal_receiver_timeout = 60s              # Timeout for WAL receiver
wal_retrieve_retry_interval = 5s       # Retry interval for WAL retrieval
recovery_min_apply_delay = 0            # Minimum delay for applying WAL

# QUERY TUNING
#------------------------------------------------------------------------------

# Planner Method Configuration
enable_bitmapscan = on                  # Enable bitmap scan
enable_hashagg = on                     # Enable hash aggregation
enable_hashjoin = on                    # Enable hash join
enable_indexscan = on                   # Enable index scan
enable_indexonlyscan = on               # Enable index-only scan
enable_material = on                    # Enable materialization
enable_mergejoin = on                   # Enable merge join
enable_nestloop = on                    # Enable nested loop join
enable_parallel_append = on             # Enable parallel append
enable_parallel_hash = on               # Enable parallel hash
enable_partition_pruning = on           # Enable partition pruning
enable_partitionwise_join = off         # Enable partitionwise join
enable_partitionwise_aggregate = off    # Enable partitionwise aggregate
enable_seqscan = on                     # Enable sequential scan
enable_sort = on                        # Enable explicit sort
enable_tidscan = on                     # Enable TID scan

# Planner Cost Constants
seq_page_cost = 1.0                     # Cost of a sequential page fetch
random_page_cost = 4.0                  # Cost of a non-sequentially-fetched disk page
cpu_tuple_cost = 0.01                   # Cost of processing each tuple during a query
cpu_index_tuple_cost = 0.005            # Cost of processing each index entry during an index scan
cpu_operator_cost = 0.0025              # Cost of processing each operator
parallel_tuple_cost = 0.1               # Cost of transferring a tuple from one parallel process to another
parallel_setup_cost = 1000.0            # Cost of setting up parallel query execution
jit_above_cost = 100000                 # Perform JIT compilation if query cost exceeds this
jit_inline_above_cost = 500000         # Perform JIT inlining if query cost exceeds this
jit_optimize_above_cost = 500000        # Perform JIT optimizations if query cost exceeds this

# Genetic Query Optimizer
geqo = on                               # Enable genetic query optimization
geqo_threshold = 12                     # Threshold for using GEQO
geqo_effort = 5                         # GEQO effort
geqo_pool_size = 0                      # GEQO pool size (0 = default)
geqo_generations = 0                    # GEQO generations (0 = default)
geqo_selection_bias = 2.0               # GEQO selection bias
geqo_seed = 0.0                         # GEQO seed for random numbers

# Other Planner Options
default_statistics_target = 100          # Default statistics target
constraint_exclusion = partition        # Constraint exclusion setting
cursor_tuple_fraction = 0.1             # Fraction of cursor rows to plan for
from_collapse_limit = 8                 # Limit on collapsing FROM clauses
join_collapse_limit = 8                 # Limit on collapsing JOIN clauses
force_parallel_mode = off               # Force parallel mode for testing

# REPORTING AND LOGGING
#------------------------------------------------------------------------------

# Where to Log
logging_collector = on                  # Enable logging collector
log_destination = 'stderr'               # Log destination
log_directory = 'log'                   # Log directory
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'  # Log filename pattern
log_file_mode = 0600                    # Log file mode
log_truncate_on_rotation = off          # Truncate log on rotation
log_rotation_age = 1d                   # Log rotation age
log_rotation_size = 10MB                # Log rotation size
syslog_facility = 'LOCAL0'              # Syslog facility
syslog_ident = 'postgres'               # Syslog program name
syslog_sequence_numbers = on             # Add sequence numbers to syslog messages
syslog_split_messages = on               # Split messages to syslog

# When to Log
log_min_messages = warning              # Minimum message level to log
log_min_error_statement = error         # Minimum statement level to log on error
log_min_duration_statement = 1000       # Log statements that take more than this amount of time

# What to Log
debug_print_parse = off                  # Log parse trees
debug_print_rewritten = off             # Log rewritten query trees
debug_print_plan = off                  # Log execution plans
debug_pretty_print = on                 # Indent parse and plan trees
log_checkpoints = on                    # Log checkpoints
log_connections = on                    # Log client connections
log_disconnections = on                 # Log client disconnections
log_duration = off                      # Log statement duration
log_error_verbosity = default            # Verbosity of logged messages
log_hostname = off                      # Log client hostnames
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '  # Log line prefix
log_lock_waits = on                     # Log lock waits
log_parameter_max_length = -1            # Limit parameter length in logs
log_parameter_max_length_on_error = 0   # Limit parameter length on error
log_statement = 'all'                    # Log all statements
log_replication_commands = off          # Log replication commands
log_temp_files = 10MB                   # Log temporary files larger than this
log_timezone = 'UTC'                     # Time zone for log timestamps

# PROCESS TITLE
cluster_name = 'discord-bot-prod'       # Cluster name shown in process title

# STATISTICS
#------------------------------------------------------------------------------

# Query/Index Statistics Collector
track_activities = on                   # Collect information about running commands
track_counts = on                       # Collect database statistics
track_io_timing = on                    # Collect I/O timing statistics
track_functions = none                   # Track function calls
track_activity_query_size = 1024         # Size of query string to track
stats_temp_directory = 'pg_stat_tmp'    # Temporary directory for statistics

# Statistics Monitoring
compute_query_id = auto                  # Compute query identifiers
log_statement_stats = off                # Log per-statement usage statistics
log_parser_stats = off                   # Log parser usage statistics
log_planner_stats = off                  # Log planner usage statistics
log_executor_stats = off                 # Log executor usage statistics

# AUTOVACUUM
#------------------------------------------------------------------------------

autovacuum = on                          # Enable autovacuum
log_autovacuum_min_duration = 0         # Log autovacuum activity if it takes longer than this
autovacuum_max_workers = 3              # Maximum number of autovacuum worker processes
autovacuum_naptime = 1min                # Time between autovacuum runs
autovacuum_vacuum_threshold = 50        # Minimum number of tuple updates before vacuum
autovacuum_analyze_threshold = 50       # Minimum number of tuple updates before analyze
autovacuum_vacuum_scale_factor = 0.2     # Fraction of table size before vacuum
autovacuum_analyze_scale_factor = 0.1    # Fraction of table size before analyze
autovacuum_freeze_max_age = 200000000    # Maximum age before forced vacuum
autovacuum_multixact_freeze_max_age = 400000000  # Maximum multixact age before forced vacuum
autovacuum_vacuum_cost_delay = 2ms       # Cost delay for autovacuum
autovacuum_vacuum_cost_limit = -1       # Cost limit for autovacuum

# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

# Statement Behavior
client_min_messages = notice            # Minimum message level to send to client
search_path = '"$user", public'         # Schema search order
row_security = on                       # Enable row security
default_table_access_method = 'heap'    # Default table access method
default_tablespace = ''                 # Default tablespace
temp_tablespaces = ''                   # Temporary tablespaces
default_toast_compression = 'pglz'      # Default TOAST compression method
check_function_bodies = on              # Check function bodies during CREATE FUNCTION
default_transaction_isolation = 'read committed'  # Default transaction isolation level
default_transaction_read_only = off     # Default transaction read-only status
default_transaction_deferrable = off    # Default transaction deferrable status
session_replication_role = 'origin'     # Session replication role
statement_timeout = 0                   # Statement timeout
lock_timeout = 0                        # Lock timeout
idle_in_transaction_session_timeout = 0  # Idle in transaction session timeout
vacuum_freeze_min_age = 50000000        # Minimum age before vacuum can freeze rows
vacuum_freeze_table_age = 150000000     # Age at which vacuum should scan whole table
vacuum_multixact_freeze_min_age = 5000000  # Minimum multixact age before vacuum can freeze
vacuum_multixact_freeze_table_age = 150000000  # Age at which vacuum should scan whole table for multixacts
vacuum_cleanup_index_scale_factor = 0.1  # Fraction of relsize to use index cleanup threshold
bytea_output = 'hex'                    # bytea output format
xmlbinary = 'base64'                    # XML binary encoding
xmloption = 'content'                   # XML parsing option
gin_fuzzy_search_limit = 0              # GIN fuzzy search limit
gin_pending_list_limit = 4MB             # GIN pending list limit

# Locale and Formatting
datestyle = 'iso, mdy'                  # Date display format
intervalstyle = 'postgres'               # Interval output style
timezone = 'UTC'                        # Time zone for display
timezone_abbreviations = 'Default'      # Select time zone abbreviation set
extra_float_digits = 1                  # Extra floating-point digits
client_encoding = sql_ascii              # Client encoding

# Shared Library Preloading
local_preload_libraries = ''            # Libraries to preload for each session
session_preload_libraries = ''          # Libraries to preload for each session
shared_preload_libraries = ''           # Libraries to preload for all sessions
jit_provider = 'llvmjit'                # JIT provider to use

# Other Defaults
dynamic_library_path = '$libdir'        # Path for dynamic libraries
gin_pending_list_limit = 4MB             # GIN pending list limit